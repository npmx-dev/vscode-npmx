import type { CodeActionContext, Diagnostic, TextDocument } from 'vscode'
import { describe, expect, it, vi } from 'vitest'
import { Range, Uri } from 'vscode'
import { VulnerabilityCodeActionProvider } from '../src/providers/code-actions/vulnerability'

function createDiagnostic(options: { code: string | { value: string }, message: string }): Diagnostic {
  return {
    code: options.code,
    message: options.message,
    range: new Range(0, 0, 0, 6),
  } as Diagnostic
}

function createTextDocument(versionText: string): TextDocument {
  return {
    uri: Uri.parse('file:///package.json'),
    getText: vi.fn(() => versionText),
  } as unknown as TextDocument
}

function createCodeActionContext(diagnostics: Diagnostic[]): CodeActionContext {
  return {
    diagnostics,
    triggerKind: 1 as CodeActionContext['triggerKind'],
    only: undefined,
  }
}

describe('vulnerability code action provider', () => {
  it('provides a quick fix when vulnerability message includes upgrade version', () => {
    const provider = new VulnerabilityCodeActionProvider()
    const textDocument = createTextDocument('^1.0.0')

    const diagnostic = createDiagnostic({
      code: { value: 'vulnerability' },
      message: 'This version has 1 high vulnerability. Upgrade to 1.2.3 to fix.',
    })

    const codeActions = provider.provideCodeActions(
      textDocument,
      diagnostic.range,
      createCodeActionContext([diagnostic]),
    )

    expect(codeActions).toEqual([
      expect.objectContaining({
        title: 'Update to ^1.2.3 to fix vulnerabilities',
        isPreferred: true,
      }),
    ])
  })

  it('does not provide a quick fix when vulnerability message has no upgrade target', () => {
    const provider = new VulnerabilityCodeActionProvider()
    const textDocument = createTextDocument('^1.0.0')

    const diagnostic = createDiagnostic({
      code: { value: 'vulnerability' },
      message: 'This version has 1 high vulnerability.',
    })

    const codeActions = provider.provideCodeActions(
      textDocument,
      diagnostic.range,
      createCodeActionContext([diagnostic]),
    )

    expect(codeActions).toHaveLength(0)
  })

  it('does not provide a quick fix when current version already matches fixed version', () => {
    const provider = new VulnerabilityCodeActionProvider()
    const textDocument = createTextDocument('~1.2.3')

    const diagnostic = createDiagnostic({
      code: { value: 'vulnerability' },
      message: 'This version has 1 high vulnerability. Upgrade to 1.2.3 to fix.',
    })

    const codeActions = provider.provideCodeActions(
      textDocument,
      diagnostic.range,
      createCodeActionContext([diagnostic]),
    )

    expect(codeActions).toHaveLength(0)
  })

  it('does not rely on encoded vulnerability code values', () => {
    const provider = new VulnerabilityCodeActionProvider()
    const textDocument = createTextDocument('^1.0.0')

    const diagnostic = createDiagnostic({
      code: { value: 'vulnerability|1.2.3' },
      message: 'This version has 1 high vulnerability. Upgrade to 1.2.3 to fix.',
    })

    const codeActions = provider.provideCodeActions(
      textDocument,
      diagnostic.range,
      createCodeActionContext([diagnostic]),
    )

    expect(codeActions).toHaveLength(0)
  })
})

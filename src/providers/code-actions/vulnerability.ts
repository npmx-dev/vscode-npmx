import type { CodeActionContext, CodeActionProvider, Diagnostic, Range, TextDocument } from 'vscode'
import { formatVersion, parseVersion } from '#utils/package'
import { CodeAction, CodeActionKind, WorkspaceEdit } from 'vscode'

const FIXED_VERSION_MESSAGE_PATTERN = / Upgrade to (?<fixedInVersion>\S+) to fix\.$/

function getDiagnosticCodeValue(diagnostic: Diagnostic): string | null {
  if (typeof diagnostic.code === 'string')
    return diagnostic.code

  if (typeof diagnostic.code === 'object' && typeof diagnostic.code.value === 'string')
    return diagnostic.code.value

  return null
}

function isVulnerabilityDiagnostic(diagnostic: Diagnostic): boolean {
  return getDiagnosticCodeValue(diagnostic) === 'vulnerability'
}

function getFixedInVersion(diagnostic: Diagnostic): string | null {
  if (!isVulnerabilityDiagnostic(diagnostic))
    return null

  const fixedInVersionMatch = FIXED_VERSION_MESSAGE_PATTERN.exec(diagnostic.message)
  const fixedInVersion = fixedInVersionMatch?.groups?.fixedInVersion
  return fixedInVersion && fixedInVersion.length > 0 ? fixedInVersion : null
}

function createUpdateVersionAction(document: TextDocument, range: Range, fixedInVersion: string): CodeAction {
  const currentVersion = document.getText(range)
  const parsedCurrentVersion = parseVersion(currentVersion)
  const formattedFixedVersion = parsedCurrentVersion
    ? formatVersion({ ...parsedCurrentVersion, semver: fixedInVersion })
    : fixedInVersion

  const codeAction = new CodeAction(`Update to ${formattedFixedVersion} to fix vulnerabilities`, CodeActionKind.QuickFix)
  codeAction.isPreferred = true
  const workspaceEdit = new WorkspaceEdit()
  workspaceEdit.replace(document.uri, range, formattedFixedVersion)
  codeAction.edit = workspaceEdit

  return codeAction
}

export class VulnerabilityCodeActionProvider implements CodeActionProvider {
  provideCodeActions(document: TextDocument, _range: Range, context: CodeActionContext): CodeAction[] {
    return context.diagnostics.flatMap((diagnostic) => {
      const fixedInVersion = getFixedInVersion(diagnostic)
      if (!fixedInVersion)
        return []

      const currentVersion = document.getText(diagnostic.range)
      const currentSemver = parseVersion(currentVersion)?.semver
      const fixedSemver = parseVersion(fixedInVersion)?.semver ?? fixedInVersion
      if (currentSemver && currentSemver === fixedSemver)
        return []

      return [createUpdateVersionAction(document, diagnostic.range, fixedInVersion)]
    })
  }
}

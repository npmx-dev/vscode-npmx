import type { OsvSeverityLevel } from '#utils/npmx'
import type { DiagnosticRule } from '..'
import { getVulnerability, SEVERITY_LEVELS } from '#utils/npmx'
import { extractVersion } from '#utils/version'
import { DiagnosticSeverity } from 'vscode'

const DIAGNOSTIC_MAPPING: Record<Exclude<OsvSeverityLevel, 'unknown'>, DiagnosticSeverity> = {
  critical: DiagnosticSeverity.Error,
  high: DiagnosticSeverity.Warning,
  moderate: DiagnosticSeverity.Information,
  low: DiagnosticSeverity.Hint,
}

export const checkVulnerability: DiagnosticRule = async (dep, pkg) => {
  const exactVersion = extractVersion(dep.version)
  const versionInfo = pkg.versionsMeta[exactVersion]

  if (!versionInfo)
    return

  const { totalCounts } = await getVulnerability({ name: dep.name, version: exactVersion })

  const message: string[] = []
  let severity: DiagnosticSeverity | null = null

  for (const s of SEVERITY_LEVELS) {
    const count = totalCounts[s]

    if (count <= 0)
      continue

    if (!severity)
      severity = DIAGNOSTIC_MAPPING[s]

    message.push(`${count} ${s}`)
  }

  if (!message.length)
    return

  return {
    node: dep.versionNode,
    message: `This version has ${message.join(', ')} ${message.length === 1 ? 'vulnerability' : 'vulnerabilities'}`,
    severity: DiagnosticSeverity.Error,
  }
}
